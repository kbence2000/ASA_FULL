name = "workflow-slave"
main = "worker.js"
compatibility_date = "2025-01-01"
compatibility_flags = [ "nodejs_compat" ]
upload_format = "modules"

# üö´ No build step ‚Äî NO npm, NO vite, NO bundler
[build]
command = ""

# ==========================================
# üåê ENVIRONMENT VARIABLES
# These must be added in Cloudflare dashboard (Settings ‚Üí Variables)
# They are declared here for clarity ‚Äì no secrets in file!
# ==========================================

[vars]
GITHUB_OWNER = "kbence2000"
GITHUB_REPO = "ASA_FULL"
BASE_BRANCH = "main"

# Optional but supported:
# DEFAULT_PATHS = "src, apps, packages"

# ==========================================
# üîê SECRETS (DO NOT PUT THEM HERE)
# Add them in Cloudflare Dashboard ‚Üí Workers ‚Üí workflow-slave ‚Üí Settings ‚Üí Variables
# - GITHUB_TOKEN
# - OPENAI_API_KEY
# - CLOUDFLARE_API_TOKEN
# ==========================================

# ==========================================
# üîó BINDINGS (if using KV, R2, D1, DO, Queues, Service Bindings)
# Add only when needed
# ==========================================

# Example (remove if unused):
# [[kv_namespaces]]
# binding = "ASA_KV"
# id = "xxxxxxxxxxxxxxxxxxxx"

# ==========================================
# üõ´ TRIGGERS (optional)
# ==========================================

# Example CRON (disabled by default):
# [triggers]
# crons = ["*/5 * * * *"]

worker.ts ‚Äì Cloudflare Worker entrypoint p√©ld√°nak

import { SupraVision } from "./asa-supravision";
import { ASA_AAAN } from "./asa-aaan";
import { createGithubAiRefactorAgent } from "./agents/github-ai-refactor";

export default {
  async fetch(request: Request, env: any, ctx: ExecutionContext) {
    const supra = new SupraVision();
    const aaan = new ASA_AAAN(supra, {
      minScoreDeltaToCommit: 2,
      allowHighRiskAgents: false,
    });

    aaan.registerAgent(createGithubAiRefactorAgent(env));

    const ctxImpl = {
      fetch,
      log: (msg: string, extra?: any) =>
        console.log("[ASA-AAAN]", msg, extra ?? ""),
      getMetrics: async () => {
        // IDE j√∂n: CF Worker logok, Base44 health endpoint, GitHub CI metrics, stb.
        // Most egy dummy p√©lda:
        return [
          {
            ts: Date.now(),
            source: "worker:asa-bridge",
            kind: "latency",
            value: 620,
          },
          {
            ts: Date.now(),
            source: "worker:asa-bridge",
            kind: "error_rate",
            value: 0.03,
          },
        ];
      },
      applyChange: async (plan) => {
        // Itt csin√°lod a val√≥di dolgokat:
        // - GitHub API: patch + commit + push
        // - Base44 API: pipeline / env update
        // - CF: Wrangler API h√≠v√°s
        console.log("Applying change plan:", plan.description);
      },
    };

    const results = await aaan.runOnce(ctxImpl);

    return new Response(
      JSON.stringify(
        {
          status: "ok",
          results,
        },
        null,
        2,
      ),
      { headers: { "content-type": "application/json" } },
    );
  },
};