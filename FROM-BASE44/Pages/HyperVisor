import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';
import { 
  Shield, Radio, Send, Eye, EyeOff, Lock, Unlock,
  Activity, Loader2, CheckCircle2, XCircle, Key
} from 'lucide-react';
import { toast } from 'sonner';

export default function Hypervisor() {
  const queryClient = useQueryClient();
  const [userMessage, setUserMessage] = useState('');
  const [systemPrompt, setSystemPrompt] = useState('Te egy hipervizor alatt fut√≥ AI asszisztens vagy.');
  const [showRaw, setShowRaw] = useState(false);
  const [selectedTask, setSelectedTask] = useState(null);

  const { data: tasks = [] } = useQuery({
    queryKey: ['hypervisorTasks'],
    queryFn: () => base44.entities.HypervisorTask.list('-created_date', 50),
    refetchInterval: 5000,
  });

  const executeTask = useMutation({
    mutationFn: async () => {
      const taskId = `task-${Date.now()}`;
      const startTime = Date.now();

      const task = await base44.entities.HypervisorTask.create({
        task_id: taskId,
        type: 'openai-chat',
        status: 'pending',
        payload: {
          system: systemPrompt,
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: userMessage }
          ]
        },
        rx_channel: 'rx-main',
        tx_channel: 'tx-main',
      });

      // Update to running
      await base44.entities.HypervisorTask.update(task.id, { status: 'running' });

      // Simulate scrambling key generation (every 4th char)
      const payload = JSON.stringify({ system: systemPrompt, user: userMessage });
      let key = '';
      for (let i = 3; i < payload.length; i += 4) {
        key += payload[i];
      }
      if (!key) key = 'fallback-key';

      // Execute AI task
      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `${systemPrompt}\n\nUser: ${userMessage}`,
      });

      // Scramble output
      const scrambled = scrambleText(result, key);
      const executionTime = Date.now() - startTime;

      // Update with results
      await base44.entities.HypervisorTask.update(task.id, {
        status: 'completed',
        raw_output: result,
        scrambled_output: scrambled,
        scramble_key: key,
        execution_time_ms: executionTime,
      });

      return task;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['hypervisorTasks']);
      setUserMessage('');
      toast.success('Task executed & scrambled successfully');
    },
    onError: () => {
      toast.error('Task execution failed');
    },
  });

  const scrambleText = (text, key) => {
    if (!text || !key) return '';
    const out = [];
    for (let i = 0; i < text.length; i++) {
      const k = key.charCodeAt(i % key.length) % 13;
      const c = text.charCodeAt(i);
      out.push(String.fromCharCode(c + k));
    }
    return out.join('') + '|' + key.length.toString(16);
  };

  const descrambleText = (scrambled, key) => {
    if (!scrambled || !key) return '';
    const [body] = scrambled.split('|');
    const out = [];
    for (let i = 0; i < body.length; i++) {
      const k = key.charCodeAt(i % key.length) % 13;
      const c = body.charCodeAt(i);
      out.push(String.fromCharCode(c - k));
    }
    return out.join('');
  };

  const runningTasks = tasks.filter(t => t.status === 'running').length;
  const completedTasks = tasks.filter(t => t.status === 'completed').length;
  const successRate = tasks.length > 0 ? ((completedTasks / tasks.length) * 100).toFixed(1) : 100;

  return (
    <div className="max-w-[2000px] mx-auto">
      <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
        <div>
          <h1 className="text-3xl md:text-4xl font-bold text-white mb-2 glow-text">Hypervisor Engine</h1>
          <p className="text-slate-400 text-sm">RX/TX Scrambling Matrix ‚Ä¢ Secure Task Orchestration</p>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-cyan-500/10">
              <Activity className="w-5 h-5 text-cyan-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Active Tasks</p>
              <p className="text-xl font-bold text-white">{runningTasks}</p>
            </div>
          </div>
        </Card>
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-green-500/10">
              <CheckCircle2 className="w-5 h-5 text-green-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Completed</p>
              <p className="text-xl font-bold text-white">{completedTasks}</p>
            </div>
          </div>
        </Card>
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-purple-500/10">
              <Shield className="w-5 h-5 text-purple-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Success Rate</p>
              <p className="text-xl font-bold text-white">{successRate}%</p>
            </div>
          </div>
        </Card>
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-indigo-500/10">
              <Lock className="w-5 h-5 text-indigo-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Encryption</p>
              <p className="text-xl font-bold text-white">RX/TX</p>
            </div>
          </div>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left Panel - Task Execution */}
        <div className="lg:col-span-2 space-y-6">
          <Card className="bg-slate-900/50 border-slate-800 p-6">
            <div className="flex items-center gap-2 mb-4">
              <Radio className="w-5 h-5 text-cyan-400 heartbeat" />
              <h2 className="text-xl font-bold text-white">Execute Hypervisor Task</h2>
            </div>

            <div className="space-y-4">
              <div>
                <label className="text-sm text-slate-300 mb-2 block">System Prompt</label>
                <Input
                  value={systemPrompt}
                  onChange={(e) => setSystemPrompt(e.target.value)}
                  placeholder="System instructions..."
                  className="bg-slate-800 border-slate-700 text-white"
                />
              </div>

              <div>
                <label className="text-sm text-slate-300 mb-2 block">User Message</label>
                <Textarea
                  value={userMessage}
                  onChange={(e) => setUserMessage(e.target.value)}
                  placeholder="Enter your message... Will be encrypted via RX channel"
                  className="bg-slate-800 border-slate-700 text-white h-32"
                />
              </div>

              <div className="flex items-center gap-2 p-3 rounded-lg bg-indigo-500/10 border border-indigo-500/30">
                <Shield className="w-4 h-4 text-indigo-400" />
                <p className="text-xs text-indigo-300">
                  üîê Input will be scrambled via RX channel, processed, then TX scrambled
                </p>
              </div>

              <Button
                onClick={() => executeTask.mutate()}
                disabled={!userMessage || executeTask.isPending}
                className="w-full bg-gradient-to-r from-cyan-600 to-indigo-600"
              >
                {executeTask.isPending ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Executing & Scrambling...
                  </>
                ) : (
                  <>
                    <Send className="w-4 h-4 mr-2" />
                    Execute Task
                  </>
                )}
              </Button>
            </div>
          </Card>

          {/* Selected Task Detail */}
          {selectedTask && (
            <Card className="bg-slate-900/50 border-slate-800 p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-bold text-white">Task Output</h3>
                <div className="flex items-center gap-2">
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => setShowRaw(!showRaw)}
                    className="border-slate-700"
                  >
                    {showRaw ? <EyeOff className="w-4 h-4 mr-2" /> : <Eye className="w-4 h-4 mr-2" />}
                    {showRaw ? 'Hide Raw' : 'Show Raw'}
                  </Button>
                </div>
              </div>

              <Tabs defaultValue="scrambled">
                <TabsList className="bg-slate-800/50">
                  <TabsTrigger value="scrambled">
                    <Lock className="w-4 h-4 mr-2" />
                    Scrambled
                  </TabsTrigger>
                  {showRaw && (
                    <TabsTrigger value="raw">
                      <Unlock className="w-4 h-4 mr-2" />
                      Raw (Trusted)
                    </TabsTrigger>
                  )}
                </TabsList>

                <TabsContent value="scrambled" className="mt-4">
                  <div className="p-4 rounded-lg bg-slate-800/50 border border-slate-700">
                    <div className="flex items-center gap-2 mb-2">
                      <Key className="w-4 h-4 text-yellow-400" />
                      <p className="text-xs text-slate-400">Key: <span className="text-yellow-400 font-mono">{selectedTask.scramble_key}</span></p>
                    </div>
                    <pre className="text-sm text-cyan-400 font-mono whitespace-pre-wrap break-all">
                      {selectedTask.scrambled_output}
                    </pre>
                  </div>
                </TabsContent>

                {showRaw && (
                  <TabsContent value="raw" className="mt-4">
                    <div className="p-4 rounded-lg bg-red-900/10 border border-red-500/30">
                      <p className="text-xs text-red-400 mb-2">‚ö†Ô∏è Trusted consumer view only</p>
                      <pre className="text-sm text-white whitespace-pre-wrap">
                        {descrambleText(selectedTask.scrambled_output, selectedTask.scramble_key)}
                      </pre>
                    </div>
                  </TabsContent>
                )}
              </Tabs>
            </Card>
          )}
        </div>

        {/* Right Panel - Task History */}
        <div className="space-y-6">
          <Card className="bg-slate-900/50 border-slate-800 p-4">
            <h3 className="text-sm font-semibold text-white mb-3 flex items-center gap-2">
              <Activity className="w-4 h-4 text-indigo-400" />
              Task History
            </h3>
            <div className="space-y-2 max-h-[600px] overflow-y-auto">
              {tasks.map((task) => (
                <button
                  key={task.id}
                  onClick={() => setSelectedTask(task)}
                  className={`w-full text-left p-3 rounded-lg border transition-all ${
                    selectedTask?.id === task.id
                      ? 'bg-slate-800 border-indigo-500/50'
                      : 'bg-slate-800/50 border-slate-700/50 hover:border-slate-700'
                  }`}
                >
                  <div className="flex items-center justify-between mb-1">
                    <p className="text-sm font-medium text-white truncate">{task.task_id}</p>
                    <Badge className={
                      task.status === 'completed' ? 'bg-green-500/10 text-green-400 border-green-500/30' :
                      task.status === 'running' ? 'bg-cyan-500/10 text-cyan-400 border-cyan-500/30' :
                      task.status === 'failed' ? 'bg-red-500/10 text-red-400 border-red-500/30' :
                      'bg-slate-500/10 text-slate-400 border-slate-500/30'
                    }>
                      {task.status}
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between text-xs text-slate-500">
                    <span>{task.rx_channel} ‚Üí {task.tx_channel}</span>
                    {task.execution_time_ms && (
                      <span>{task.execution_time_ms}ms</span>
                    )}
                  </div>
                </button>
              ))}
            </div>
          </Card>

          <Card className="bg-slate-900/50 border-slate-800 p-4">
            <h3 className="text-sm font-semibold text-white mb-3">RX/TX Matrix</h3>
            <div className="space-y-2">
              <div className="p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/30">
                <div className="flex items-center gap-2 mb-1">
                  <Radio className="w-4 h-4 text-cyan-400" />
                  <p className="text-sm text-cyan-400 font-semibold">RX Channel</p>
                </div>
                <p className="text-xs text-slate-400">Input scrambling & key derivation</p>
              </div>
              <div className="p-3 rounded-lg bg-indigo-500/10 border border-indigo-500/30">
                <div className="flex items-center gap-2 mb-1">
                  <Radio className="w-4 h-4 text-indigo-400" />
                  <p className="text-sm text-indigo-400 font-semibold">TX Channel</p>
                </div>
                <p className="text-xs text-slate-400">Output scrambling & secure transmission</p>
              </div>
            </div>
          </Card>
        </div>
      </div>
    </div>
  );
}
