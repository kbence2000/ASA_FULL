import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Switch } from '@/components/ui/switch';
import { 
  Wrench, Target, DollarSign, Play, Shield, CheckCircle2, 
  XCircle, AlertTriangle, Loader2, FileText, GitBranch, Rocket
} from 'lucide-react';
import { toast } from 'sonner';

export default function AiOps() {
  const queryClient = useQueryClient();
  const [description, setDescription] = useState('');
  const [taskKind, setTaskKind] = useState('bugfix');
  const [preferredEnv, setPreferredEnv] = useState('staging');
  const [maxBudget, setMaxBudget] = useState(500);
  const [autoApply, setAutoApply] = useState(false);

  const { data: requests = [] } = useQuery({
    queryKey: ['aiOpsRequests'],
    queryFn: () => base44.entities.AiOpsRequest.list('-created_date', 50),
    refetchInterval: 5000,
  });

  const { data: user } = useQuery({
    queryKey: ['currentUser'],
    queryFn: () => base44.auth.me(),
  });

  const createRequest = useMutation({
    mutationFn: async () => {
      const requestId = `aiops-${Date.now()}`;
      
      const request = await base44.entities.AiOpsRequest.create({
        request_id: requestId,
        requested_by: user?.email || 'unknown',
        description,
        task_kind: taskKind,
        preferred_env: preferredEnv,
        status: 'pending',
        auto_apply: autoApply,
        max_budget_eur: maxBudget,
      });

      // Simulate AI planning
      toast.loading('AI analyzing problem...', { id: 'planning' });
      
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      const planSteps = [
        {
          id: 'step-1',
          title: 'Analyze logs and metrics',
          kind: 'infra',
          estimatedMinutes: 10,
          riskLevel: 'low',
          canAutoApply: true
        },
        {
          id: 'step-2',
          title: 'Implement fix',
          kind: taskKind,
          estimatedMinutes: 30,
          riskLevel: 'medium',
          canAutoApply: true
        },
        {
          id: 'step-3',
          title: 'Deploy to ' + preferredEnv,
          kind: 'deployment',
          estimatedMinutes: 15,
          riskLevel: preferredEnv === 'prod' ? 'high' : 'medium',
          canAutoApply: preferredEnv !== 'prod'
        }
      ];

      const totalMinutes = planSteps.reduce((sum, s) => sum + s.estimatedMinutes, 0);
      const hourlyRate = 120;
      const estimatedCost = Math.round((totalMinutes / 60) * hourlyRate * 100) / 100;

      await base44.entities.AiOpsRequest.update(request.id, {
        status: 'planning',
        plan_steps: planSteps,
        estimated_minutes: totalMinutes,
        estimated_cost_eur: estimatedCost,
        severity: 'medium',
      });

      toast.success('Plan generated', { id: 'planning' });

      // Auto-execute if allowed
      if (autoApply && estimatedCost <= maxBudget && totalMinutes <= 60) {
        toast.loading('Executing plan...', { id: 'executing' });
        await new Promise(resolve => setTimeout(resolve, 3000));

        const execResults = planSteps.map(step => ({
          stepId: step.id,
          status: 'success',
          logExcerpt: `Executed ${step.title} successfully`
        }));

        await base44.entities.AiOpsRequest.update(request.id, {
          status: 'completed',
          execution_results: execResults,
          git_commit_sha: 'commit-' + Date.now(),
        });

        toast.success('Plan executed successfully', { id: 'executing' });
      } else {
        await base44.entities.AiOpsRequest.update(request.id, {
          status: 'quoted',
          safety_blocked_reason: autoApply 
            ? `Budget or time exceeded safety limits`
            : 'Manual approval required'
        });
        toast.info('Manual approval required');
      }

      return request;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['aiOpsRequests']);
      setDescription('');
    },
    onError: () => {
      toast.error('Failed to create request');
    },
  });

  const getStatusIcon = (status) => {
    switch (status) {
      case 'completed': return <CheckCircle2 className="w-5 h-5 text-green-400" />;
      case 'failed': return <XCircle className="w-5 h-5 text-red-400" />;
      case 'executing': return <Loader2 className="w-5 h-5 text-cyan-400 animate-spin" />;
      case 'blocked': return <AlertTriangle className="w-5 h-5 text-yellow-400" />;
      default: return <Target className="w-5 h-5 text-slate-400" />;
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'completed': return 'bg-green-500/10 text-green-400 border-green-500/30';
      case 'failed': return 'bg-red-500/10 text-red-400 border-red-500/30';
      case 'executing': return 'bg-cyan-500/10 text-cyan-400 border-cyan-500/30';
      case 'blocked': return 'bg-yellow-500/10 text-yellow-400 border-yellow-500/30';
      default: return 'bg-slate-500/10 text-slate-400 border-slate-500/30';
    }
  };

  const getSeverityColor = (severity) => {
    switch (severity) {
      case 'critical': return 'text-red-400';
      case 'high': return 'text-orange-400';
      case 'medium': return 'text-yellow-400';
      case 'low': return 'text-green-400';
      default: return 'text-slate-400';
    }
  };

  const stats = {
    total: requests.length,
    completed: requests.filter(r => r.status === 'completed').length,
    executing: requests.filter(r => r.status === 'executing').length,
    totalSaved: requests.reduce((sum, r) => sum + (r.estimated_minutes || 0), 0),
  };

  return (
    <div className="max-w-[2000px] mx-auto">
      <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
        <div>
          <h1 className="text-3xl md:text-4xl font-bold text-white mb-2 glow-text">AI OPS Engine</h1>
          <p className="text-slate-400 text-sm">Remote deploy • Debug • Fix • Problem solver with military-grade audit</p>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-indigo-500/10">
              <Target className="w-5 h-5 text-indigo-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Total Requests</p>
              <p className="text-xl font-bold text-white">{stats.total}</p>
            </div>
          </div>
        </Card>
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-green-500/10">
              <CheckCircle2 className="w-5 h-5 text-green-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Completed</p>
              <p className="text-xl font-bold text-white">{stats.completed}</p>
            </div>
          </div>
        </Card>
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-cyan-500/10">
              <Loader2 className="w-5 h-5 text-cyan-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Active</p>
              <p className="text-xl font-bold text-white">{stats.executing}</p>
            </div>
          </div>
        </Card>
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-purple-500/10">
              <Wrench className="w-5 h-5 text-purple-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Time Saved</p>
              <p className="text-xl font-bold text-white">{stats.totalSaved}m</p>
            </div>
          </div>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left - Create Request */}
        <div className="lg:col-span-2">
          <Card className="bg-slate-900/50 border-slate-800 p-6">
            <div className="flex items-center gap-2 mb-4">
              <Wrench className="w-5 h-5 text-indigo-400 heartbeat" />
              <h2 className="text-xl font-bold text-white">New AI OPS Request</h2>
            </div>

            <div className="space-y-4">
              <div>
                <label className="text-sm text-slate-300 mb-2 block">Problem Description</label>
                <Textarea
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  placeholder="Describe the problem in natural language... e.g., 'API returns 500 errors under high load'"
                  className="bg-slate-800 border-slate-700 text-white h-32"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-sm text-slate-300 mb-2 block">Task Type</label>
                  <Select value={taskKind} onValueChange={setTaskKind}>
                    <SelectTrigger className="bg-slate-800 border-slate-700 text-white">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="bugfix">Bug Fix</SelectItem>
                      <SelectItem value="performance">Performance</SelectItem>
                      <SelectItem value="security">Security</SelectItem>
                      <SelectItem value="deployment">Deployment</SelectItem>
                      <SelectItem value="infra">Infrastructure</SelectItem>
                      <SelectItem value="refactor">Refactor</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <label className="text-sm text-slate-300 mb-2 block">Target Environment</label>
                  <Select value={preferredEnv} onValueChange={setPreferredEnv}>
                    <SelectTrigger className="bg-slate-800 border-slate-700 text-white">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="dev">Development</SelectItem>
                      <SelectItem value="staging">Staging</SelectItem>
                      <SelectItem value="prod">Production</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div>
                <label className="text-sm text-slate-300 mb-2 block">Max Budget (EUR)</label>
                <Input
                  type="number"
                  value={maxBudget}
                  onChange={(e) => setMaxBudget(Number(e.target.value))}
                  className="bg-slate-800 border-slate-700 text-white"
                />
              </div>

              <div className="flex items-center justify-between p-3 rounded-lg bg-slate-800/50">
                <div>
                  <p className="text-sm text-white font-medium">Auto-Apply Changes</p>
                  <p className="text-xs text-slate-500">Execute automatically if within safety limits</p>
                </div>
                <Switch
                  checked={autoApply}
                  onCheckedChange={setAutoApply}
                />
              </div>

              {preferredEnv === 'prod' && (
                <div className="flex items-center gap-2 p-3 rounded-lg bg-red-500/10 border border-red-500/30">
                  <Shield className="w-4 h-4 text-red-400" />
                  <p className="text-xs text-red-300">
                    ⚠️ Production auto-apply is disabled by safety guard
                  </p>
                </div>
              )}

              <Button
                onClick={() => createRequest.mutate()}
                disabled={!description || createRequest.isPending}
                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600"
              >
                {createRequest.isPending ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Processing...
                  </>
                ) : (
                  <>
                    <Rocket className="w-4 h-4 mr-2" />
                    Submit AI OPS Request
                  </>
                )}
              </Button>
            </div>
          </Card>
        </div>

        {/* Right - Request History */}
        <div>
          <Card className="bg-slate-900/50 border-slate-800 p-4">
            <h3 className="text-sm font-semibold text-white mb-3 flex items-center gap-2">
              <FileText className="w-4 h-4 text-indigo-400" />
              Request History
            </h3>
            <div className="space-y-2 max-h-[600px] overflow-y-auto">
              {requests.map((req) => (
                <div
                  key={req.id}
                  className="p-3 rounded-lg bg-slate-800/50 border border-slate-700/50 hover:border-slate-700 transition-all"
                >
                  <div className="flex items-center justify-between mb-2">
                    {getStatusIcon(req.status)}
                    <Badge className={getStatusColor(req.status)}>
                      {req.status}
                    </Badge>
                  </div>
                  <p className="text-sm text-white mb-1 line-clamp-2">{req.description}</p>
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-slate-500">{req.task_kind}</span>
                    {req.estimated_cost_eur && (
                      <span className="text-green-400 font-semibold">€{req.estimated_cost_eur}</span>
                    )}
                  </div>
                  {req.plan_steps && (
                    <div className="mt-2 pt-2 border-t border-slate-700">
                      <p className="text-xs text-slate-400">{req.plan_steps.length} steps planned</p>
                    </div>
                  )}
                  {req.git_commit_sha && (
                    <div className="mt-2 flex items-center gap-1 text-xs text-cyan-400">
                      <GitBranch className="w-3 h-3" />
                      {req.git_commit_sha.slice(0, 12)}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </Card>
        </div>
      </div>
    </div>
  );
}
