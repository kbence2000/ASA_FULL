import React, { useState, useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { 
  Cpu, Zap, Activity, TrendingUp, AlertTriangle, Radio,
  Thermometer, Wind, Box, Loader2, Shield
} from 'lucide-react';
import { toast } from 'sonner';

export default function SuperSync() {
  const queryClient = useQueryClient();
  const [taskInput, setTaskInput] = useState('');
  const [taskType, setTaskType] = useState('AI_OPS');

  const { data: processors = [] } = useQuery({
    queryKey: ['protocolProcessors'],
    queryFn: () => base44.entities.ProtocolProcessor.list('-created_date', 10),
    refetchInterval: 3000,
  });

  const { data: telemetry = [] } = useQuery({
    queryKey: ['telemetrySamples'],
    queryFn: () => base44.entities.TelemetrySample.list('-created_date', 50),
    refetchInterval: 2000,
  });

  const { data: tasks = [] } = useQuery({
    queryKey: ['hypervisorTasks'],
    queryFn: () => base44.entities.HypervisorTask.list('-created_date', 20),
    refetchInterval: 5000,
  });

  // Initialize processors if empty
  useEffect(() => {
    if (processors.length === 0) {
      ['pp-1', 'pp-2', 'pp-3', 'pp-4'].forEach(async (id, idx) => {
        await base44.entities.ProtocolProcessor.create({
          processor_id: id,
          state: idx < 2 ? 'HOT' : 'COLD',
          current_load: 0,
          tasks_processed: 0,
        });
      });
      queryClient.invalidateQueries(['protocolProcessors']);
    }
  }, []);

  // Generate random telemetry
  useEffect(() => {
    const interval = setInterval(async () => {
      const metrics = ['space', 'resonance', 'airPressure'];
      const randomMetric = metrics[Math.floor(Math.random() * metrics.length)];
      
      let value, unit, alertLevel;
      if (randomMetric === 'space') {
        value = 40 + Math.random() * 50;
        unit = '%';
        alertLevel = value > 85 ? 'critical' : value > 60 ? 'warning' : 'normal';
      } else if (randomMetric === 'resonance') {
        value = 20 + Math.random() * 60;
        unit = 'idx';
        alertLevel = value > 70 ? 'critical' : value > 40 ? 'warning' : 'normal';
      } else {
        value = 980 + Math.random() * 60;
        unit = 'hPa';
        alertLevel = value > 1050 || value < 900 ? 'critical' : value > 950 || value < 980 ? 'warning' : 'normal';
      }

      await base44.entities.TelemetrySample.create({
        sample_id: `sample-${Date.now()}`,
        metric: randomMetric,
        value: Math.round(value * 10) / 10,
        unit,
        alert_level: alertLevel,
        processor_id: processors.length > 0 ? processors[0].processor_id : 'pp-1',
      });

      // Scale up on critical
      if (alertLevel === 'critical' && processors.length > 0) {
        processors.forEach(async (p) => {
          if (p.state === 'COLD') {
            await base44.entities.ProtocolProcessor.update(p.id, { state: 'HOT' });
          }
        });
      }
    }, 5000);

    return () => clearInterval(interval);
  }, [processors]);

  const executeTask = useMutation({
    mutationFn: async () => {
      const taskId = `task-${Date.now()}`;
      
      const hotProcessors = processors.filter(p => p.state === 'HOT');
      const chosenProcessor = hotProcessors.sort((a, b) => a.current_load - b.current_load)[0];

      if (!chosenProcessor) {
        throw new Error('No HOT processors available');
      }

      const task = await base44.entities.HypervisorTask.create({
        task_id: taskId,
        type: taskType,
        status: 'pending',
        payload: {
          input: taskInput,
          telemetryContext: telemetry.slice(-5),
        },
        rx_channel: 'rx-task',
        tx_channel: 'tx-control',
      });

      await base44.entities.HypervisorTask.update(task.id, { status: 'running' });

      // Simulate processing
      await new Promise(resolve => setTimeout(resolve, 3000));

      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `You are the Hypervisor Super Sync AI-OPS Engine.\n\nTask Type: ${taskType}\nInput: ${taskInput}\n\nAnalyze and provide optimization recommendations.`,
      });

      // Scramble simulation
      const scrambleKey = Math.floor(Math.random() * 251) + 5;

      await base44.entities.HypervisorTask.update(task.id, {
        status: 'completed',
        raw_output: result,
        scrambled_output: `[SCRAMBLED:${scrambleKey.toString(16)}]${result.slice(0, 50)}...`,
        scramble_key: scrambleKey.toString(16),
      });

      // Update processor
      await base44.entities.ProtocolProcessor.update(chosenProcessor.id, {
        current_load: Math.min(1, chosenProcessor.current_load + 0.1),
        tasks_processed: (chosenProcessor.tasks_processed || 0) + 1,
        last_task_at: new Date().toISOString(),
      });

      return task;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['hypervisorTasks']);
      queryClient.invalidateQueries(['protocolProcessors']);
      setTaskInput('');
      toast.success('Task executed via RX/TX channels');
    },
    onError: () => {
      toast.error('Task execution failed');
    },
  });

  const getMetricIcon = (metric) => {
    switch (metric) {
      case 'space': return <Box className="w-4 h-4" />;
      case 'resonance': return <Radio className="w-4 h-4" />;
      case 'airPressure': return <Wind className="w-4 h-4" />;
      default: return <Activity className="w-4 h-4" />;
    }
  };

  const getAlertColor = (level) => {
    switch (level) {
      case 'critical': return 'text-red-400';
      case 'warning': return 'text-yellow-400';
      default: return 'text-green-400';
    }
  };

  const hotProcessors = processors.filter(p => p.state === 'HOT').length;
  const avgLoad = processors.length > 0 ? processors.reduce((sum, p) => sum + p.current_load, 0) / processors.length : 0;
  const criticalAlerts = telemetry.filter(t => t.alert_level === 'critical').length;

  return (
    <div className="max-w-[2000px] mx-auto">
      <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
        <div>
          <h1 className="text-3xl md:text-4xl font-bold text-white mb-2 glow-text">Hypervisor Super Sync</h1>
          <p className="text-slate-400 text-sm">AI-OPS • RX/TX Matrix • Telemetry Engine • 4 Protocol Processors</p>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-indigo-500/10">
              <Cpu className="w-5 h-5 text-indigo-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">HOT Processors</p>
              <p className="text-xl font-bold text-white">{hotProcessors}/4</p>
            </div>
          </div>
        </Card>
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-cyan-500/10">
              <Activity className="w-5 h-5 text-cyan-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Avg Load</p>
              <p className="text-xl font-bold text-white">{Math.round(avgLoad * 100)}%</p>
            </div>
          </div>
        </Card>
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-red-500/10">
              <AlertTriangle className="w-5 h-5 text-red-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Critical Alerts</p>
              <p className="text-xl font-bold text-white">{criticalAlerts}</p>
            </div>
          </div>
        </Card>
        <Card className="bg-slate-900/50 border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-green-500/10">
              <Shield className="w-5 h-5 text-green-400" />
            </div>
            <div>
              <p className="text-xs text-slate-400">Tasks Done</p>
              <p className="text-xl font-bold text-white">{tasks.filter(t => t.status === 'completed').length}</p>
            </div>
          </div>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left - Execute Task */}
        <div className="lg:col-span-2 space-y-6">
          <Card className="bg-slate-900/50 border-slate-800 p-6">
            <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
              <Zap className="w-5 h-5 text-cyan-400 heartbeat" />
              Execute Hypervisor Task
            </h2>

            <div className="space-y-4">
              <div className="flex gap-2">
                {['AI_OPS', 'SCAN_INFRA', 'REMOTE_FIX'].map((type) => (
                  <Button
                    key={type}
                    size="sm"
                    variant={taskType === type ? 'default' : 'outline'}
                    onClick={() => setTaskType(type)}
                    className={taskType === type ? 'bg-indigo-600' : 'border-slate-700'}
                  >
                    {type.replace('_', ' ')}
                  </Button>
                ))}
              </div>

              <Textarea
                value={taskInput}
                onChange={(e) => setTaskInput(e.target.value)}
                placeholder="Enter task input... (will be RX scrambled)"
                className="bg-slate-800 border-slate-700 text-white h-32"
              />

              <Button
                onClick={() => executeTask.mutate()}
                disabled={!taskInput || executeTask.isPending}
                className="w-full bg-gradient-to-r from-cyan-600 to-indigo-600"
              >
                {executeTask.isPending ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Processing via RX/TX...
                  </>
                ) : (
                  <>
                    <Zap className="w-4 h-4 mr-2" />
                    Execute Task
                  </>
                )}
              </Button>
            </div>
          </Card>

          {/* Protocol Processors */}
          <Card className="bg-slate-900/50 border-slate-800 p-6">
            <h3 className="text-lg font-bold text-white mb-4">Protocol Processors (2 HOT / 2 COLD)</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {processors.map((processor) => (
                <div
                  key={processor.id}
                  className={`p-4 rounded-lg border ${
                    processor.state === 'HOT'
                      ? 'bg-indigo-500/10 border-indigo-500/30'
                      : processor.state === 'COLD'
                      ? 'bg-slate-800/50 border-slate-700'
                      : 'bg-red-500/10 border-red-500/30'
                  }`}
                >
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-bold text-white">{processor.processor_id}</span>
                    <Badge className={
                      processor.state === 'HOT'
                        ? 'bg-indigo-500/20 text-indigo-400 border-indigo-500/30'
                        : 'bg-slate-500/20 text-slate-400 border-slate-500/30'
                    }>
                      {processor.state}
                    </Badge>
                  </div>
                  <div className="space-y-2">
                    <div>
                      <div className="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Load</span>
                        <span>{Math.round(processor.current_load * 100)}%</span>
                      </div>
                      <Progress value={processor.current_load * 100} className="h-1" />
                    </div>
                    <div className="text-xs text-slate-500">
                      Tasks: {processor.tasks_processed || 0}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </Card>
        </div>

        {/* Right - Telemetry */}
        <div className="space-y-6">
          <Card className="bg-slate-900/50 border-slate-800 p-4">
            <h3 className="text-sm font-semibold text-white mb-3 flex items-center gap-2">
              <TrendingUp className="w-4 h-4 text-cyan-400" />
              Live Telemetry
            </h3>
            <div className="space-y-2 max-h-[600px] overflow-y-auto">
              {telemetry.slice(0, 20).map((sample) => (
                <div
                  key={sample.id}
                  className="p-2 rounded-lg bg-slate-800/50 border border-slate-700/50"
                >
                  <div className="flex items-center justify-between mb-1">
                    <div className="flex items-center gap-2">
                      {getMetricIcon(sample.metric)}
                      <span className="text-xs text-white capitalize">{sample.metric}</span>
                    </div>
                    <span className={`text-sm font-bold ${getAlertColor(sample.alert_level)}`}>
                      {sample.value} {sample.unit}
                    </span>
                  </div>
                  {sample.alert_level !== 'normal' && (
                    <div className="text-xs text-slate-500">
                      Alert: {sample.alert_level}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </Card>
        </div>
      </div>
    </div>
  );
}
