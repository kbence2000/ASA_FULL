import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { Badge } from '@/components/ui/badge';
import { Plus, Code2, GitBranch, CheckCircle, XCircle, Clock, ExternalLink } from 'lucide-react';

export default function CodeLab() {
  const [dialogOpen, setDialogOpen] = useState(false);
  const [newProject, setNewProject] = useState({
    name: '',
    type: 'module',
    language: 'python',
    status: 'draft',
    description: '',
  });

  const queryClient = useQueryClient();

  const { data: projects = [] } = useQuery({
    queryKey: ['code-projects'],
    queryFn: () => base44.entities.CodeProject.list('-updated_date'),
  });

  const createProjectMutation = useMutation({
    mutationFn: (data) => base44.entities.CodeProject.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries(['code-projects']);
      setDialogOpen(false);
      setNewProject({ name: '', type: 'module', language: 'python', status: 'draft', description: '' });
    },
  });

  const getTypeColor = (type) => {
    const colors = {
      module: 'text-indigo-400 bg-indigo-500/10 border-indigo-500/30',
      integration: 'text-cyan-400 bg-cyan-500/10 border-cyan-500/30',
      experiment: 'text-purple-400 bg-purple-500/10 border-purple-500/30',
      prototype: 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30',
      production: 'text-green-400 bg-green-500/10 border-green-500/30',
    };
    return colors[type] || colors.module;
  };

  const getStatusColor = (status) => {
    const colors = {
      draft: 'text-slate-400 bg-slate-500/10 border-slate-500/30',
      development: 'text-cyan-400 bg-cyan-500/10 border-cyan-500/30',
      testing: 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30',
      deployed: 'text-green-400 bg-green-500/10 border-green-500/30',
      archived: 'text-slate-400 bg-slate-500/10 border-slate-500/30',
    };
    return colors[status] || colors.draft;
  };

  const getBuildStatusIcon = (status) => {
    const icons = {
      passing: CheckCircle,
      failing: XCircle,
      pending: Clock,
    };
    return icons[status] || Clock;
  };

  const languageStats = projects.reduce((acc, p) => {
    acc[p.language] = (acc[p.language] || 0) + 1;
    return acc;
  }, {});

  const statusStats = {
    draft: projects.filter(p => p.status === 'draft').length,
    development: projects.filter(p => p.status === 'development').length,
    deployed: projects.filter(p => p.status === 'deployed').length,
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-4xl font-bold text-white mb-2 glow-text">Code Lab</h1>
          <p className="text-slate-400">{projects.length} active projects</p>
        </div>
        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
          <DialogTrigger asChild>
            <Button className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700">
              <Plus className="w-4 h-4 mr-2" />
              New Project
            </Button>
          </DialogTrigger>
          <DialogContent className="bg-slate-900 border-slate-800 max-w-2xl">
            <DialogHeader>
              <DialogTitle className="text-white">Create Code Project</DialogTitle>
            </DialogHeader>
            <div className="space-y-4 mt-4">
              <div>
                <Label className="text-slate-300">Project Name</Label>
                <Input
                  value={newProject.name}
                  onChange={(e) => setNewProject({ ...newProject, name: e.target.value })}
                  placeholder="e.g., Advanced Neural Router"
                  className="bg-slate-800 border-slate-700 text-white mt-1"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label className="text-slate-300">Project Type</Label>
                  <Select value={newProject.type} onValueChange={(v) => setNewProject({ ...newProject, type: v })}>
                    <SelectTrigger className="bg-slate-800 border-slate-700 text-white mt-1">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent className="bg-slate-800 border-slate-700">
                      <SelectItem value="module" className="text-white">Module</SelectItem>
                      <SelectItem value="integration" className="text-white">Integration</SelectItem>
                      <SelectItem value="experiment" className="text-white">Experiment</SelectItem>
                      <SelectItem value="prototype" className="text-white">Prototype</SelectItem>
                      <SelectItem value="production" className="text-white">Production</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label className="text-slate-300">Language</Label>
                  <Select value={newProject.language} onValueChange={(v) => setNewProject({ ...newProject, language: v })}>
                    <SelectTrigger className="bg-slate-800 border-slate-700 text-white mt-1">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent className="bg-slate-800 border-slate-700">
                      <SelectItem value="python" className="text-white">Python</SelectItem>
                      <SelectItem value="javascript" className="text-white">JavaScript</SelectItem>
                      <SelectItem value="typescript" className="text-white">TypeScript</SelectItem>
                      <SelectItem value="rust" className="text-white">Rust</SelectItem>
                      <SelectItem value="cpp" className="text-white">C++</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div>
                <Label className="text-slate-300">Description</Label>
                <Textarea
                  value={newProject.description}
                  onChange={(e) => setNewProject({ ...newProject, description: e.target.value })}
                  placeholder="Project description..."
                  className="bg-slate-800 border-slate-700 text-white mt-1 h-24"
                />
              </div>

              <div>
                <Label className="text-slate-300">Repository URL (optional)</Label>
                <Input
                  value={newProject.repository_url || ''}
                  onChange={(e) => setNewProject({ ...newProject, repository_url: e.target.value })}
                  placeholder="https://github.com/..."
                  className="bg-slate-800 border-slate-700 text-white mt-1"
                />
              </div>

              <Button
                onClick={() => createProjectMutation.mutate(newProject)}
                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600"
                disabled={!newProject.name}
              >
                Create Project
              </Button>
            </div>
          </DialogContent>
        </Dialog>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card className="bg-slate-900/50 border-slate-800 backdrop-blur-sm p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-slate-500/10">
              <Code2 className="w-5 h-5 text-slate-400" />
            </div>
            <div>
              <p className="text-2xl font-bold text-white">{statusStats.draft}</p>
              <p className="text-xs text-slate-400">Draft Projects</p>
            </div>
          </div>
        </Card>

        <Card className="bg-slate-900/50 border-slate-800 backdrop-blur-sm p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-cyan-500/10">
              <GitBranch className="w-5 h-5 text-cyan-400" />
            </div>
            <div>
              <p className="text-2xl font-bold text-white">{statusStats.development}</p>
              <p className="text-xs text-slate-400">In Development</p>
            </div>
          </div>
        </Card>

        <Card className="bg-slate-900/50 border-slate-800 backdrop-blur-sm p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-green-500/10">
              <CheckCircle className="w-5 h-5 text-green-400" />
            </div>
            <div>
              <p className="text-2xl font-bold text-white">{statusStats.deployed}</p>
              <p className="text-xs text-slate-400">Deployed</p>
            </div>
          </div>
        </Card>

        <Card className="bg-slate-900/50 border-slate-800 backdrop-blur-sm p-4">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-purple-500/10">
              <Code2 className="w-5 h-5 text-purple-400" />
            </div>
            <div>
              <p className="text-2xl font-bold text-white">{Object.keys(languageStats).length}</p>
              <p className="text-xs text-slate-400">Languages</p>
            </div>
          </div>
        </Card>
      </div>

      {/* Projects Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {projects.map((project) => {
          const typeColor = getTypeColor(project.type);
          const statusColor = getStatusColor(project.status);
          const BuildIcon = getBuildStatusIcon(project.build_status);

          return (
            <Card key={project.id} className="bg-slate-900/50 border-slate-800 backdrop-blur-sm hover:border-indigo-500/30 transition-all">
              <div className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <Code2 className="w-5 h-5 text-indigo-400" />
                      <h3 className="text-lg font-semibold text-white">{project.name}</h3>
                    </div>
                    {project.description && (
                      <p className="text-sm text-slate-400 mb-3 line-clamp-2">{project.description}</p>
                    )}
                    <div className="flex flex-wrap gap-2">
                      <Badge className={`${typeColor} border text-xs`}>
                        {project.type}
                      </Badge>
                      <Badge className={`${statusColor} border text-xs`}>
                        {project.status}
                      </Badge>
                      <Badge variant="outline" className="border-slate-700 text-slate-400 text-xs">
                        {project.language}
                      </Badge>
                    </div>
                  </div>
                </div>

                <div className="flex items-center justify-between pt-4 border-t border-slate-800">
                  <div className="flex items-center gap-2">
                    <BuildIcon className={`w-4 h-4 ${
                      project.build_status === 'passing' ? 'text-green-400' :
                      project.build_status === 'failing' ? 'text-red-400' :
                      'text-slate-400'
                    }`} />
                    <span className="text-xs text-slate-400">
                      Build: <span className={
                        project.build_status === 'passing' ? 'text-green-400' :
                        project.build_status === 'failing' ? 'text-red-400' :
                        'text-slate-400'
                      }>{project.build_status || 'pending'}</span>
                    </span>
                  </div>

                  {project.repository_url && (
                    <a
                      href={project.repository_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-1 text-xs text-indigo-400 hover:text-indigo-300 transition-colors"
                    >
                      <GitBranch className="w-3 h-3" />
                      Repository
                      <ExternalLink className="w-3 h-3" />
                    </a>
                  )}
                </div>

                {project.last_commit && (
                  <div className="text-xs text-slate-500 mt-2">
                    Last commit: {new Date(project.last_commit).toLocaleString()}
                  </div>
                )}
              </div>
            </Card>
          );
        })}

        {projects.length === 0 && (
          <Card className="lg:col-span-2 bg-slate-900/50 border-slate-800 backdrop-blur-sm p-12">
            <div className="text-center">
              <Code2 className="w-12 h-12 text-slate-600 mx-auto mb-4" />
              <p className="text-slate-400">No projects yet</p>
              <p className="text-sm text-slate-500 mt-2">Create your first code project to get started</p>
            </div>
          </Card>
        )}
      </div>
    </div>
  );
}
