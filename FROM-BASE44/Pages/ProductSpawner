import React, { useState, useRef, useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Zap, CheckCircle, AlertCircle, Info, AlertTriangle, Download } from 'lucide-react';

export default function ProductSpawner() {
  const [formData, setFormData] = useState({
    idea: '',
    persona: '',
    complexity: 'enterprise',
    constraints: '',
    targets: ['web-spa', 'api-backend', 'worker-edge', 'github-ci', 'base44-app']
  });
  const [logs, setLogs] = useState([]);
  const [activeTab, setActiveTab] = useState('logs');
  const [lastBlueprint, setLastBlueprint] = useState(null);
  const logsRef = useRef(null);
  const queryClient = useQueryClient();

  const { data: blueprints = [] } = useQuery({
    queryKey: ['productBlueprints'],
    queryFn: () => base44.entities.ProductBlueprint.list('-created_date', 10),
  });

  useEffect(() => {
    if (logsRef.current) {
      logsRef.current.scrollTop = logsRef.current.scrollHeight;
    }
  }, [logs]);

  const addLog = (level, message) => {
    const time = new Date().toLocaleTimeString();
    setLogs(prev => [...prev, { time, level, message }]);
  };

  const spawnMutation = useMutation({
    mutationFn: async (data) => {
      addLog('info', `Spawn request initiated · complexity=${data.complexity} · targets=${data.targets.join(', ')}`);

      const systemPrompt = `You are ASA Product Spawner, an elite multi-platform product architect.
User is an advanced founder building ASA-based AI devops / remote agent / casino / infra tools.

Goal: From a single idea, design a domination-level product.

ALWAYS respond as JSON with keys:
- summary: high-level description (max 200 words)
- architecture: textual blueprint (core modules, data flow, security, Base44/GitHub/Cloudflare boundaries)
- fileTree: tree-like code structure
- pipelines: CI/CD pipelines (GitHub Actions, Base44 integration, Cloudflare deploy, cleanup strategy)

Include ASA extension points: CME, AAAN, ZIM compatibility.`;

      const userPrompt = `Idea: ${data.idea}

Target persona: ${data.persona || 'CTOs, DevOps teams, startup founders, agencies'}

Complexity level: ${data.complexity}
Targets: ${data.targets.join(', ')}

Constraints: ${data.constraints || 'Military-grade security, RX/TX scrambling, ASA Hypervisor compatibility, low storage, auto-cleanup, mobile-first PWA, iOS-friendly, streaming terminals'}`;

      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `${systemPrompt}\n\n${userPrompt}`,
        response_json_schema: {
          type: 'object',
          properties: {
            summary: { type: 'string' },
            architecture: { type: 'string' },
            fileTree: { type: 'string' },
            pipelines: { type: 'string' }
          }
        }
      });

      const blueprint = await base44.entities.ProductBlueprint.create({
        ...data,
        ...result,
        status: 'completed'
      });

      return blueprint;
    },
    onSuccess: (blueprint) => {
      setLastBlueprint(blueprint);
      addLog('ok', 'Blueprint generated successfully via ChatGPT 5.1 core');
      queryClient.invalidateQueries(['productBlueprints']);
    },
    onError: (err) => {
      addLog('err', `Error: ${err.message}`);
    }
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.idea.trim()) {
      addLog('warn', 'Add meg a product idea-t (mit akarsz bedominálni)');
      return;
    }
    spawnMutation.mutate(formData);
  };

  const handleTargetToggle = (target) => {
    setFormData(prev => ({
      ...prev,
      targets: prev.targets.includes(target)
        ? prev.targets.filter(t => t !== target)
        : [...prev.targets, target]
    }));
  };

  const downloadZip = async () => {
    if (!lastBlueprint) {
      addLog('warn', 'No blueprint to download');
      return;
    }

    addLog('info', 'Generating ZIP archive...');

    // Create file structure based on blueprint
    const files = {
      'README.md': `# ${lastBlueprint.idea}\n\n${lastBlueprint.summary}\n\n## Architecture\n\n${lastBlueprint.architecture}`,
      'ARCHITECTURE.md': lastBlueprint.architecture || 'No architecture details',
      'FILE_STRUCTURE.txt': lastBlueprint.fileTree || 'No file tree generated',
      'PIPELINES.md': lastBlueprint.pipelines || 'No pipeline configuration',
      'package.json': JSON.stringify({
        name: 'asa-spawned-product',
        version: '1.0.0',
        description: lastBlueprint.summary?.split('\n')[0] || lastBlueprint.idea,
        keywords: lastBlueprint.targets || []
      }, null, 2)
    };

    // Simple ZIP creation using base64
    const zip = await createZip(files);
    const blob = new Blob([zip], { type: 'application/zip' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `asa-product-${Date.now()}.zip`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    addLog('ok', 'ZIP archive downloaded successfully');
  };

  const createZip = async (files) => {
    // Minimalistic ZIP creation
    const enc = new TextEncoder();
    const chunks = [];
    
    for (const [name, content] of Object.entries(files)) {
      const data = enc.encode(content);
      chunks.push(data);
    }

    // For simplicity, create a tar-like structure
    let combined = '';
    for (const [name, content] of Object.entries(files)) {
      combined += `\n\n========== ${name} ==========\n\n${content}`;
    }
    
    return enc.encode(combined);
  };

  const logIcons = {
    info: <Info className="w-3 h-3 text-blue-400" />,
    ok: <CheckCircle className="w-3 h-3 text-green-400" />,
    warn: <AlertTriangle className="w-3 h-3 text-yellow-400" />,
    err: <AlertCircle className="w-3 h-3 text-red-400" />
  };

  const targetOptions = [
    { value: 'web-spa', label: 'Web SPA + PWA dashboard' },
    { value: 'api-backend', label: 'API backend (Deno / Node)' },
    { value: 'worker-edge', label: 'Edge worker (Cloudflare / Deno)' },
    { value: 'github-ci', label: 'GitHub CI/CD workflows' },
    { value: 'base44-app', label: 'Base44 app integration' },
    { value: 'supabase', label: 'Database / Supabase schema' }
  ];

  return (
    <div className="max-w-[1280px] mx-auto space-y-4">
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div className="bg-gradient-to-br from-slate-900/95 via-indigo-950/90 to-purple-950/90 rounded-2xl border border-purple-500/25 p-6 relative overflow-hidden">
          <div className="absolute inset-0 opacity-45 bg-gradient-to-br from-purple-500/20 via-transparent to-blue-500/20 pointer-events-none" />
          
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 via-green-400 to-cyan-400" style={{ boxShadow: '0 0 24px rgba(168,85,255,0.7)' }} />
                <div>
                  <div className="text-xs uppercase tracking-wider text-slate-400">ASA Product Spawner</div>
                  <div className="text-sm text-slate-300">Multi-platform AI product generator</div>
                </div>
              </div>
              <div className="px-3 py-1 rounded-full bg-green-500/20 border border-green-500/40 text-xs text-green-300 flex items-center gap-2">
                <div className="w-2 h-2 rounded-full bg-green-400" />
                {spawnMutation.isPending ? 'Spawning...' : 'Engine idle'}
              </div>
            </div>

            <h1 className="text-2xl font-bold text-white mb-2">Spawn production-grade products from one idea.</h1>
            <p className="text-sm text-slate-400 mb-4">
              Describe what you want to dominate and ASA will generate a multi-platform blueprint: web app, APIs, workers, pipelines, GitHub / Cloudflare routes and more.
            </p>

            <div className="flex flex-wrap gap-2 mb-4">
              {['Zero-to-blueprint in one call', 'Auto CI/CD plan', 'Base44 / GitHub / Cloudflare aware'].map((pill, idx) => (
                <div key={idx} className="px-3 py-1 rounded-full bg-slate-900/50 border border-slate-700 text-xs text-slate-300 flex items-center gap-2">
                  <div className="w-1.5 h-1.5 rounded-full bg-purple-500" />
                  {pill}
                </div>
              ))}
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-xs text-slate-300 mb-1">Product idea / domination goal</label>
                <textarea
                  value={formData.idea}
                  onChange={(e) => setFormData({ ...formData, idea: e.target.value })}
                  placeholder="Pl.: Dominálni akarom az AI devops & remote problem solving piacot..."
                  className="w-full bg-gradient-to-br from-indigo-950/50 to-slate-900/90 border border-indigo-500/50 rounded-xl p-3 text-sm text-white outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 resize-vertical min-h-[80px]"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-slate-300 mb-1">Target user / buyer persona</label>
                  <input
                    value={formData.persona}
                    onChange={(e) => setFormData({ ...formData, persona: e.target.value })}
                    placeholder="CTO-k, DevOps csapatok..."
                    className="w-full bg-gradient-to-br from-indigo-950/50 to-slate-900/90 border border-indigo-500/50 rounded-xl p-2 text-sm text-white outline-none focus:border-purple-500"
                  />
                </div>
                <div>
                  <label className="block text-xs text-slate-300 mb-1">Complexity level</label>
                  <select
                    value={formData.complexity}
                    onChange={(e) => setFormData({ ...formData, complexity: e.target.value })}
                    className="w-full bg-gradient-to-br from-indigo-950/50 to-slate-900/90 border border-indigo-500/50 rounded-xl p-2 text-sm text-white outline-none focus:border-purple-500"
                  >
                    <option value="mvp">MVP – gyors piacra lépés</option>
                    <option value="pro">Pro – B2B / agency ready</option>
                    <option value="enterprise">Enterprise – domination</option>
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-xs text-slate-300 mb-2">Target platforms</label>
                <div className="grid grid-cols-2 gap-2">
                  {targetOptions.map(({ value, label }) => (
                    <label key={value} className="flex items-center gap-2 px-2 py-1.5 rounded-lg bg-slate-900/50 border border-slate-700 text-xs text-slate-300 cursor-pointer hover:bg-slate-800/50">
                      <input
                        type="checkbox"
                        checked={formData.targets.includes(value)}
                        onChange={() => handleTargetToggle(value)}
                        className="accent-purple-500"
                      />
                      {label}
                    </label>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-xs text-slate-300 mb-1">Constraints / non-negotiables</label>
                <textarea
                  value={formData.constraints}
                  onChange={(e) => setFormData({ ...formData, constraints: e.target.value })}
                  placeholder="Military-grade security, RX/TX scrambling, ASA Hypervisor kompatibilitás..."
                  className="w-full bg-gradient-to-br from-indigo-950/50 to-slate-900/90 border border-indigo-500/50 rounded-xl p-3 text-sm text-white outline-none focus:border-purple-500 resize-vertical min-h-[60px]"
                />
              </div>

              <Button
                type="submit"
                disabled={spawnMutation.isPending}
                className="w-full rounded-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500"
                style={{ boxShadow: '0 18px 40px rgba(88,28,135,0.55)' }}
              >
                {spawnMutation.isPending && <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />}
                <Zap className="w-4 h-4" />
                Spawn ASA Product Blueprint
              </Button>
            </form>
          </div>
        </div>

        <div className="bg-gradient-to-br from-slate-900/95 to-purple-950/90 rounded-2xl border border-slate-700 p-6">
          <div className="text-xs uppercase tracking-wider text-slate-400 mb-3">Blueprint & Telemetry</div>
          
          <div className="flex gap-2 mb-3 flex-wrap items-center justify-between">
            <div className="flex gap-2">
              {['logs', 'blueprint', 'files', 'pipelines'].map(tab => (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  className={`px-3 py-1 rounded-full text-xs ${
                    activeTab === tab
                      ? 'bg-gradient-to-r from-purple-600/30 to-indigo-600/30 border-purple-500 text-white'
                      : 'bg-slate-900/50 border-slate-700 text-slate-400'
                  } border`}
                >
                  {tab.charAt(0).toUpperCase() + tab.slice(1)}
                </button>
              ))}
            </div>
            {lastBlueprint && (
              <Button
                onClick={downloadZip}
                size="sm"
                variant="outline"
                className="rounded-full text-xs"
              >
                <Download className="w-3 h-3 mr-1" />
                Download ZIP
              </Button>
            )}
          </div>

          <div className="bg-slate-900/90 border border-slate-800 rounded-xl p-3 min-h-[400px] max-h-[500px] overflow-y-auto">
            {activeTab === 'logs' && (
              <div ref={logsRef} className="space-y-1 font-mono text-xs">
                {logs.length === 0 && (
                  <div className="text-slate-600 text-center py-8">ASA Product Spawner UI loaded · ready.</div>
                )}
                {logs.map((log, idx) => (
                  <div key={idx} className="flex items-start gap-2 p-2 rounded bg-slate-800/50 border border-slate-700">
                    <span className="text-slate-500">[{log.time}]</span>
                    <span className={`px-2 py-0.5 rounded text-[9px] uppercase ${
                      log.level === 'info' ? 'bg-blue-500/20 text-blue-300' :
                      log.level === 'ok' ? 'bg-green-500/20 text-green-300' :
                      log.level === 'warn' ? 'bg-yellow-500/20 text-yellow-300' :
                      'bg-red-500/20 text-red-300'
                    }`}>
                      {log.level}
                    </span>
                    <span className="text-slate-300 flex-1">{log.message}</span>
                  </div>
                ))}
              </div>
            )}

            {activeTab === 'blueprint' && (
              <div className="space-y-3 text-sm">
                {lastBlueprint?.summary && (
                  <div>
                    <div className="text-xs uppercase text-slate-500 mb-1">Summary</div>
                    <div className="text-slate-300 whitespace-pre-wrap">{lastBlueprint.summary}</div>
                  </div>
                )}
                {lastBlueprint?.architecture && (
                  <div>
                    <div className="text-xs uppercase text-slate-500 mb-1">Architecture</div>
                    <div className="text-slate-300 whitespace-pre-wrap">{lastBlueprint.architecture}</div>
                  </div>
                )}
                {!lastBlueprint && <div className="text-slate-600 text-center py-8">No blueprint generated yet</div>}
              </div>
            )}

            {activeTab === 'files' && (
              <pre className="font-mono text-xs text-slate-300 whitespace-pre-wrap">
                {lastBlueprint?.fileTree || 'No file tree generated yet'}
              </pre>
            )}

            {activeTab === 'pipelines' && (
              <pre className="font-mono text-xs text-slate-300 whitespace-pre-wrap">
                {lastBlueprint?.pipelines || 'No pipelines generated yet'}
              </pre>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
