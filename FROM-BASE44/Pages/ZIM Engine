import React, { useState, useEffect, useRef } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Play, Pause, Zap, Brain, Cpu, Sparkles } from 'lucide-react';

export default function ZIMEngine() {
  const [isRunning, setIsRunning] = useState(false);
  const [sessionId] = useState(`zim-${Math.random().toString(16).slice(2, 10)}`);
  const [currentLoop, setCurrentLoop] = useState(0);
  const [emotion, setEmotion] = useState({ joy: 0.5, stress: 0.5 });
  const [logs, setLogs] = useState([]);
  const intervalRef = useRef(null);
  const queryClient = useQueryClient();

  const { data: loops = [] } = useQuery({
    queryKey: ['zimLoops', sessionId],
    queryFn: () => base44.entities.ZIMLoop.filter({ sessionId }, '-created_date', 50),
    refetchInterval: 3000,
  });

  const { data: memories = [] } = useQuery({
    queryKey: ['memories', sessionId],
    queryFn: () => base44.entities.MemoryItem.filter({ userId: sessionId }, '-updated_date', 10),
  });

  const addLog = (msg, type = 'info') => {
    setLogs(prev => [...prev.slice(-20), { msg, type, ts: Date.now() }]);
  };

  const calculateEmotion = (loop) => {
    const joy = Math.sin(loop / 2) * 0.5 + 0.5;
    const stress = Math.cos(loop / 3) * 0.5 + 0.5;
    return { joy, stress };
  };

  const hypervisorDecide = (emotion) => {
    if (emotion.stress > 0.75) {
      return { action: 'RUN_CME_ANALYSIS', reason: 'Stress high – need pattern analysis' };
    }
    if (emotion.joy > 0.6) {
      return { action: 'RUN_EVOLUTION', reason: 'Joy high – system is in creative state' };
    }
    return { action: 'RUN_AAAN_PLANNING', reason: 'Neutral state, run AAAN improvements' };
  };

  const runLoopMutation = useMutation({
    mutationFn: async () => {
      const loopNum = currentLoop + 1;
      const emo = calculateEmotion(loopNum);
      setEmotion(emo);
      setCurrentLoop(loopNum);

      const decision = hypervisorDecide(emo);
      addLog(`Loop #${loopNum}: ${decision.action}`, 'info');

      let prompt, systemPrompt, isEvolution = false;

      if (decision.action === 'RUN_CME_ANALYSIS') {
        systemPrompt = `You are ASA CME. Summarize, store patterns, track trends. Output: 1) INSIGHT: 2) MEMORY_UPDATE:`;
        prompt = 'Analyze internal state and discover new memory patterns.';
      } else if (decision.action === 'RUN_EVOLUTION') {
        systemPrompt = `You are ASA EVO. Combine subsystems into NEW modules. Output: 1) NAME 2) DESCRIPTION 3) HOW IT EVOLVED 4) WHY USEFUL 5) NEXT MUTATION`;
        prompt = 'Generate a new evolved ASA module based on the last operations. Combine at least two subsystems.';
        isEvolution = true;
      } else {
        systemPrompt = `You are ASA AAAN. Simulate PLANNER, ARCHITECT, EXECUTOR. Output: 1) PLAN 2) ARCHITECTURE 3) EXECUTION`;
        prompt = 'Plan next self-improvement pipeline for ASA.';
      }

      const memContext = memories.slice(0, 6).map(m => `MEMO: ${m.content}`).join('\n');
      const fullPrompt = `${memContext ? memContext + '\n\n' : ''}${prompt}`;

      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `${systemPrompt}\n\n${fullPrompt}`
      });

      const memoryUpdates = [];
      const match = result.match(/MEMORY_UPDATE\s*:(.*)$/is);
      if (match) {
        const updates = match[1].split('\n')
          .map(x => x.trim())
          .filter(x => x && x.toLowerCase() !== 'none')
          .slice(0, 3);
        memoryUpdates.push(...updates);

        for (const update of updates) {
          await base44.entities.MemoryItem.create({
            userId: sessionId,
            kind: 'INSIGHT',
            importance: 0.8,
            recencyScore: 1.0,
            source: 'system',
            content: update,
            tags: ['zim', decision.action.toLowerCase()]
          });
        }
      }

      await base44.entities.ZIMLoop.create({
        loopNumber: loopNum,
        action: decision.action,
        reason: decision.reason,
        emotion: emo,
        result: result.substring(0, 500),
        evolutionGenerated: isEvolution,
        memoryUpdates,
        sessionId
      });

      queryClient.invalidateQueries(['zimLoops']);
      queryClient.invalidateQueries(['memories']);
      
      addLog(`✓ ${decision.action} completed`, 'success');
      return result;
    },
    onError: (err) => {
      addLog(`✗ Error: ${err.message}`, 'error');
    }
  });

  useEffect(() => {
    if (isRunning) {
      intervalRef.current = setInterval(() => {
        runLoopMutation.mutate();
      }, 15000);
    } else {
      if (intervalRef.current) clearInterval(intervalRef.current);
    }
    return () => {
      if (intervalRef.current) clearInterval(intervalRef.current);
    };
  }, [isRunning]);

  const actionIcons = {
    RUN_CME_ANALYSIS: Brain,
    RUN_EVOLUTION: Sparkles,
    RUN_AAAN_PLANNING: Cpu
  };

  return (
    <div className="max-w-[1400px] mx-auto space-y-4">
      <div className="bg-gradient-to-br from-slate-900/95 to-purple-950/90 rounded-2xl border border-purple-500/25 p-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center animate-pulse">
              <Zap className="w-7 h-7 text-white" />
            </div>
            <div>
              <h1 className="text-2xl font-bold text-white">ASA ZIM+EVO Engine</h1>
              <p className="text-xs text-slate-400">Zero-Input Mode · Autonomous Evolution System</p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <Button
              onClick={() => setIsRunning(!isRunning)}
              variant={isRunning ? 'destructive' : 'default'}
              className={isRunning ? 'bg-red-600' : 'bg-gradient-to-r from-purple-600 to-pink-600'}
            >
              {isRunning ? (
                <>
                  <Pause className="w-4 h-4 mr-2" />
                  Stop Loop
                </>
              ) : (
                <>
                  <Play className="w-4 h-4 mr-2" />
                  Start Loop
                </>
              )}
            </Button>
          </div>
        </div>

        <div className="grid grid-cols-4 gap-3 mb-4">
          <div className="bg-slate-900/50 border border-slate-800 rounded-xl p-3">
            <div className="text-xs text-slate-500 mb-1">Loop Count</div>
            <div className="text-2xl font-bold text-white">{currentLoop}</div>
          </div>
          <div className="bg-slate-900/50 border border-slate-800 rounded-xl p-3">
            <div className="text-xs text-slate-500 mb-1">Joy Level</div>
            <div className="text-2xl font-bold text-green-400">{(emotion.joy * 100).toFixed(0)}%</div>
          </div>
          <div className="bg-slate-900/50 border border-slate-800 rounded-xl p-3">
            <div className="text-xs text-slate-500 mb-1">Stress Level</div>
            <div className="text-2xl font-bold text-red-400">{(emotion.stress * 100).toFixed(0)}%</div>
          </div>
          <div className="bg-slate-900/50 border border-slate-800 rounded-xl p-3">
            <div className="text-xs text-slate-500 mb-1">Memory Items</div>
            <div className="text-2xl font-bold text-cyan-400">{memories.length}</div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div className="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
            <div className="text-xs uppercase text-slate-400 tracking-wider mb-3">Live Logs</div>
            <div className="space-y-1 max-h-[300px] overflow-y-auto font-mono text-xs">
              {logs.length === 0 && (
                <div className="text-slate-600 text-center py-8">Waiting for loop to start...</div>
              )}
              {logs.map((log, idx) => (
                <div key={idx} className={`py-1 ${
                  log.type === 'error' ? 'text-red-400' :
                  log.type === 'success' ? 'text-green-400' :
                  'text-slate-300'
                }`}>
                  [{new Date(log.ts).toLocaleTimeString()}] {log.msg}
                </div>
              ))}
            </div>
          </div>

          <div className="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
            <div className="text-xs uppercase text-slate-400 tracking-wider mb-3">Loop History</div>
            <div className="space-y-2 max-h-[300px] overflow-y-auto">
              {loops.length === 0 && (
                <div className="text-slate-600 text-center py-8">No loops executed yet</div>
              )}
              {loops.map((loop) => {
                const Icon = actionIcons[loop.action] || Cpu;
                return (
                  <div key={loop.id} className="bg-slate-800/50 border border-slate-700 rounded-lg p-2">
                    <div className="flex items-center justify-between mb-1">
                      <div className="flex items-center gap-2">
                        <Icon className="w-3 h-3 text-purple-400" />
                        <span className="text-xs font-semibold text-white">Loop #{loop.loopNumber}</span>
                      </div>
                      <Badge className="bg-purple-500/10 text-purple-400 border-purple-500/30 text-[10px]">
                        {loop.action.replace('RUN_', '').replace(/_/g, ' ')}
                      </Badge>
                    </div>
                    <div className="text-[10px] text-slate-400">{loop.reason}</div>
                    <div className="flex gap-2 mt-1">
                      <span className="text-[10px] text-green-400">Joy: {(loop.emotion?.joy * 100).toFixed(0)}%</span>
                      <span className="text-[10px] text-red-400">Stress: {(loop.emotion?.stress * 100).toFixed(0)}%</span>
                      {loop.evolutionGenerated && (
                        <Badge className="bg-pink-500/10 text-pink-400 border-pink-500/30 text-[9px]">EVO</Badge>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        <div className="mt-4 bg-slate-900/50 border border-slate-800 rounded-xl p-4">
          <div className="text-xs uppercase text-slate-400 tracking-wider mb-3">Cognitive Memory</div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
            {memories.slice(0, 6).map((mem) => (
              <div key={mem.id} className="bg-slate-800/50 border border-slate-700 rounded-lg p-2 text-xs">
                <div className="flex items-center gap-2 mb-1">
                  <Badge className="bg-cyan-500/10 text-cyan-400 border-cyan-500/30 text-[9px]">
                    {mem.kind}
                  </Badge>
                  <span className="text-slate-500 text-[10px]">{new Date(mem.created_date).toLocaleTimeString()}</span>
                </div>
                <div className="text-slate-300">{mem.content}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}
